{% extends "layouts/base.html" %}

{% block title %}تفاصيل المقاول - {{ contractor.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <span class="text-muted fw-normal">ملف المقاول:</span> {{ contractor.name }}
    </h2>
    <a href="{{ url_for('contractor.get_contractors') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-1"></i> العودة لقائمة المقاولين
    </a>
</div>

{# --- Financial Summary Cards --- #}
<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <h3 class="mb-0">الملخص المالي للمقاول (من المستخلصات المعتمدة)</h3>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col">
                <h5>إجمالي المستحق</h5>
                <p class="fs-4 text-primary">{{ "{:,.2f}".format(total_due) }} ريال</p>
            </div>
            <div class="col">
                <h5>إجمالي المدفوع</h5>
                <p class="fs-4 text-success">{{ "{:,.2f}".format(total_paid) }} ريال</p>
            </div>
            <div class="col">
                <h5>إجمالي المتبقي</h5>
                <p class="fs-4 text-danger">{{ "{:,.2f}".format(remaining) }} ريال</p>
            </div>
        </div>
    </div>
</div>

{# --- Tabs Structure --- #}
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="contractorTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices-content" type="button" role="tab" aria-controls="invoices-content" aria-selected="true">
                    <i class="fas fa-file-invoice-dollar me-1"></i>المستخلصات ({{ invoices|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items-content" type="button" role="tab" aria-controls="items-content" aria-selected="false">
                    <i class="fas fa-tasks me-1"></i>البنود المسندة ({{ assigned_items|length }})
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="contractorTabContent">
            
            <div class="tab-pane fade show active" id="invoices-content" role="tabpanel" aria-labelledby="invoices-tab">
                
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-white-50">قائمة المستخلصات</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" id="expand-all-btn" title="توسيع الكل">
                            <i class="fas fa-angle-double-down"></i>
                        </button>
                        <button class="btn btn-outline-secondary" id="collapse-all-btn" title="طي الكل">
                            <i class="fas fa-angle-double-up"></i>
                        </button>
                    </div>
                </div>

                {% if invoices %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 3%;"></th>
                                    <th>رقم المستخلص</th>
                                    <th>المشروع</th>
                                    <th>تاريخه</th>
                                    <th class="text-end">الإجمالي</th>
                                    <th class="text-end">المدفوع</th>
                                    <th class="text-center">الحالة</th>
                                    <th class="text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="invoices-tbody">
                                {% for invoice in invoices %}
                                <tr class="align-middle">
                                    <td>
                                        {% if invoice.items %}
                                        <button class="btn btn-sm btn-outline-secondary individual-toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#invoice-items-{{ invoice.id }}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td><a href="{{ url_for('invoice.show_invoice', invoice_id=invoice.id) }}" class="fw-bold">{{ invoice.invoice_number }}</a></td>
                                    <td>{{ invoice.project.name }}</td>
                                    <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                    <td class="text-end">{{ "{:,.2f}".format(invoice.total_amount) }}</td>
                                    <td class="text-end text-success">{{ "{:,.2f}".format(invoice.paid_amount) }}</td>
                                    <td class="text-center">
                                        <span class="badge {% if invoice.status == 'مدفوع بالكامل' %} bg-success {% elif invoice.status == 'مدفوع جزئياً' %} bg-warning text-dark {% elif invoice.status == 'معتمد' %} bg-info {% elif invoice.status == 'ملغي' %} bg-danger {% else %} bg-secondary {% endif %}">
                                            {{ invoice.status }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('invoice.show_invoice', invoice_id=invoice.id) }}" class="btn btn-info btn-sm" title="عرض تفاصيل المستخلص"><i class="fas fa-eye"></i></a>
                                    </td>
                                </tr>
                                {% if invoice.items %}
                                <tr class="collapse" id="invoice-items-{{ invoice.id }}">
                                    <td colspan="8" class="p-3 bg-dark">
                                        <h6 class="text-white mb-2">تفاصيل بنود المستخلص:</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-borderless">
                                                <thead class="text-muted">
                                                    <tr>
                                                        <th>البند</th>
                                                        <th class="text-end">الإجمالي</th>
                                                        <th class="text-end">المدفوع</th>
                                                        <th class="text-end">المتبقي</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="text-white-50">
                                                    {% for inv_item in invoice.items %}
                                                    <tr>
                                                        <td>{{ inv_item.description }}</td>
                                                        <td class="text-end">{{ "{:,.2f}".format(inv_item.total_price) }}</td>
                                                        <td class="text-end text-success">{{ "{:,.2f}".format(inv_item.paid_amount) }}</td>
                                                        <td class="text-end text-danger">{{ "{:,.2f}".format(inv_item.remaining_amount) }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-secondary m-3 text-center">لا توجد مستخلصات مسجلة لهذا المقاول.</div>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="items-content" role="tabpanel" aria-labelledby="items-tab">
                {# محتوى لسان البنود المسندة يبقى كما هو #}
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const expandAllBtn = document.getElementById('expand-all-btn');
    const collapseAllBtn = document.getElementById('collapse-all-btn');
    const collapsibleItems = document.querySelectorAll('#invoices-tbody .collapse');

    function bulkToggle(action) {
        collapsibleItems.forEach(item => {
            item.classList.add('no-transition');
            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(item);
            if (action === 'show') {
                bsCollapse.show();
            } else {
                bsCollapse.hide();
            }
            setTimeout(() => {
                item.classList.remove('no-transition');
            }, 0);
        });
    }

    if (expandAllBtn && collapseAllBtn && collapsibleItems.length > 0) {
        expandAllBtn.addEventListener('click', () => bulkToggle('show'));
        collapseAllBtn.addEventListener('click', () => bulkToggle('hide'));
    }

    // --- START: الحل النهائي للأزرار الفردية ---
    const individualToggleButtons = document.querySelectorAll('.individual-toggle-btn');
    individualToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.classList.add('no-transition');
                setTimeout(() => {
                    targetElement.classList.remove('no-transition');
                }, 200); // نترك وقت بسيط للتأكد من أن الإزالة تحدث بعد انتهاء الفتح/الإغلاق
            }
        });
    });
    // --- END: الحل النهائي ---
});
</script>
{% endblock %}