{% extends "layouts/base.html" %}

<<<<<<< HEAD
{% block title %}لوحة تحكم {{ project.name }} - نظام حساب تكاليف المشاريع{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>لوحة تحكم المشروع</h1>
    <div class="btn-group">
        <a href="{{ url_for('project.get_project', project_id=project.id) }}" class="btn btn-primary">
            <i class="fas fa-info-circle me-1"></i> تفاصيل المشروع
        </a>
        <a href="{{ url_for('item.get_items', project_id=project.id) }}" class="btn btn-success">
            <i class="fas fa-list me-1"></i> عرض البنود
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0">{{ project.name }}</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card bg-light h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">التكلفة التعاقدية</h5>
                        <h3 class="text-primary">{{ "{:,.2f}".format(project.total_contract_cost) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-light h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">التكلفة الفعلية</h5>
                        <h3 class="text-success">{{ "{:,.2f}".format(project.total_actual_cost) if project.total_actual_cost else "-" }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-light h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">الوفر/الزيادة</h5>
                        <h3 class="{{ 'text-success' if project.total_savings > 0 else 'text-danger' if project.total_savings < 0 else '' }}">
                            {{ "{:,.2f}".format(project.total_savings) if project.total_savings != 0 else "-" }}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-light h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">نسبة الإنجاز</h5>
                        <div class="progress mt-3" style="height: 25px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ project.completion_percentage }}%">
                                {{ "{:.1f}%".format(project.completion_percentage) }}
                            </div>
=======
{% block title %}لوحة تحكم المشروع - {{ project.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>لوحة تحكم المشروع: {{ project.name }}</h1>
    <a href="{{ url_for("project.get_project", project_id=project.id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-1"></i> العودة لتفاصيل المشروع
    </a>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">ملخص التكاليف</h3>
            </div>
            <div class="card-body">
                <p><strong>إجمالي التكلفة التعاقدية:</strong> <span class="text-primary">{{ "{:,.2f}".format(project.total_contract_cost) }} ريال</span></p>
                <p><strong>إجمالي التكلفة الفعلية:</strong> <span class="text-success">{{ "{:,.2f}".format(project.total_actual_cost) }} ريال</span></p>
                <p><strong>الوفر / الزيادة:</strong> 
                    <span class="{{ "text-success" if project.total_savings >= 0 else "text-danger" }}">
                        {{ "{:,.2f}".format(project.total_savings) }} ريال
                    </span>
                </p>
                <p><strong>إجمالي المدفوع:</strong> <span class="text-info">{{ "{:,.2f}".format(project.total_paid_amount) }} ريال</span></p>
                <p><strong>المبلغ المتبقي:</strong> <span class="text-danger">{{ "{:,.2f}".format(project.total_remaining_amount) }} ريال</span></p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">نسب الإنجاز</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>نسبة إنجاز البنود</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ project.completion_percentage }}%">
                            {{ "{:.1f}%".format(project.completion_percentage) }}
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>نسبة الإنجاز المالي</h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ project.financial_completion_percentage }}%">
                            {{ "{:.1f}%".format(project.financial_completion_percentage) }}
>>>>>>> 7a3713e (Initial commit with updated files)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<<<<<<< HEAD
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">مقارنة التكاليف</h3>
            </div>
            <div class="card-body">
                <canvas id="costComparisonChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">حالة البنود</h3>
            </div>
            <div class="card-body">
                <canvas id="itemStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h3 class="mb-0">توزيع التكاليف حسب المقاولين</h3>
            </div>
            <div class="card-body">
                <canvas id="contractorCostChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <h3 class="mb-0">البنود ذات الوفر الأعلى</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="topSavingsTable">
                <thead class="table-dark">
                    <tr>
                        <th>رقم البند</th>
                        <th>وصف البند</th>
                        <th>التكلفة التعاقدية</th>
                        <th>التكلفة الفعلية</th>
                        <th>الوفر</th>
                        <th>نسبة الوفر</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <h3 class="mb-0">البنود ذات الزيادة الأعلى</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="topOverrunsTable">
                <thead class="table-dark">
                    <tr>
                        <th>رقم البند</th>
                        <th>وصف البند</th>
                        <th>التكلفة التعاقدية</th>
                        <th>التكلفة الفعلية</th>
                        <th>الزيادة</th>
                        <th>نسبة الزيادة</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between mt-4">
    <a href="{{ url_for('project.get_projects') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-1"></i> العودة للمشاريع
    </a>
    <a href="{{ url_for('item.get_items', project_id=project.id) }}" class="btn btn-success">
        <i class="fas fa-list me-1"></i> عرض جميع البنود
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // بيانات المشروع
        const projectData = {{ project.to_dict()|tojson }};
        
        // الحصول على بنود المشروع
        fetch(`/items/project/${projectData.id}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(items => {
            // تحليل البيانات
            const itemsByStatus = {
                'نشط': 0,
                'مكتمل': 0,
                'متوقف': 0
            };
            
            const contractorCosts = {};
            const itemsWithSavings = [];
            
            items.forEach(item => {
                // حساب عدد البنود حسب الحالة
                if (item.status in itemsByStatus) {
                    itemsByStatus[item.status]++;
                }
                
                // حساب التكاليف حسب المقاول
                if (item.contractor_name) {
                    if (!contractorCosts[item.contractor_name]) {
                        contractorCosts[item.contractor_name] = 0;
                    }
                    contractorCosts[item.contractor_name] += item.actual_total_cost || item.contract_total_cost;
                }
                
                // حساب الوفر/الزيادة للبنود
                if (item.actual_total_cost !== null && item.contract_total_cost !== null) {
                    const savings = item.contract_total_cost - item.actual_total_cost;
                    const savingsPercentage = (savings / item.contract_total_cost) * 100;
                    
                    itemsWithSavings.push({
                        ...item,
                        savings,
                        savingsPercentage
                    });
                }
            });
            
            // رسم مخطط مقارنة التكاليف
            const costCtx = document.getElementById('costComparisonChart').getContext('2d');
            new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: ['التكلفة التعاقدية', 'التكلفة الفعلية'],
                    datasets: [{
                        label: 'التكاليف',
                        data: [projectData.total_contract_cost, projectData.total_actual_cost || 0],
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)'],
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'مقارنة التكاليف التعاقدية والفعلية'
                        }
                    }
                }
            });
            
            // رسم مخطط حالة البنود
            const statusCtx = document.getElementById('itemStatusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(itemsByStatus),
                    datasets: [{
                        data: Object.values(itemsByStatus),
                        backgroundColor: [
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'توزيع البنود حسب الحالة'
                        }
                    }
                }
            });
            
            // رسم مخطط توزيع التكاليف حسب المقاولين
            const contractorLabels = Object.keys(contractorCosts);
            const contractorValues = Object.values(contractorCosts);
            
            if (contractorLabels.length > 0) {
                const contractorCtx = document.getElementById('contractorCostChart').getContext('2d');
                new Chart(contractorCtx, {
                    type: 'horizontalBar',
                    data: {
                        labels: contractorLabels,
                        datasets: [{
                            label: 'التكلفة',
                            data: contractorValues,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'توزيع التكاليف حسب المقاولين'
                            }
                        }
                    }
                });
            } else {
                document.getElementById('contractorCostChart').parentElement.innerHTML = 
                    '<div class="alert alert-info">لا توجد بيانات كافية لعرض توزيع التكاليف حسب المقاولين.</div>';
            }
            
            // عرض البنود ذات الوفر الأعلى
            const topSavings = itemsWithSavings
                .filter(item => item.savings > 0)
                .sort((a, b) => b.savings - a.savings)
                .slice(0, 5);
                
            const topSavingsTable = document.getElementById('topSavingsTable').getElementsByTagName('tbody')[0];
            
            if (topSavings.length > 0) {
                topSavings.forEach(item => {
                    const row = topSavingsTable.insertRow();
                    row.innerHTML = `
                        <td>${item.item_number}</td>
                        <td>${item.description}</td>
                        <td class="text-end">${item.contract_total_cost.toLocaleString('ar-SA', {minimumFractionDigits: 2})}</td>
                        <td class="text-end">${item.actual_total_cost.toLocaleString('ar-SA', {minimumFractionDigits: 2})}</td>
                        <td class="text-end text-success">${item.savings.toLocaleString('ar-SA', {minimumFractionDigits: 2})}</td>
                        <td class="text-end text-success">${item.savingsPercentage.toFixed(1)}%</td>
                    `;
                });
            } else {
                topSavingsTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">لا توجد بنود ذات وفر حالياً</td>
                    </tr>
                `;
            }
            
            // عرض البنود ذات الزيادة الأعلى
            const topOverruns = itemsWithSavings
                .filter(item => item.savings < 0)
                .sort((a, b) => a.savings - b.savings)
                .slice(0, 5);
                
            const topOverrunsTable = document.getElementById('topOverrunsTable').getElementsByTagName('tbody')[0];
            
            if (topOverruns.length > 0) {
                topOverruns.forEach(item => {
                    const row = topOverrunsTable.insertRow();
                    row.innerHTML = `
                        <td>${item.item_number}</td>
                        <td>${item.description}</td>
                        <td class="text-end">${item.contract_total_cost.toLocaleString('ar-SA', {minimumFractionDigits: 2})}</td>
                        <td class="text-end">${item.actual_total_cost.toLocaleString('ar-SA', {minimumFractionDigits: 2})}</td>
                        <td class="text-end text-danger">${Math.abs(item.savings).toLocaleString('ar-SA', {minimumFractionDigits: 2})}</td>
                        <td class="text-end text-danger">${Math.abs(item.savingsPercentage).toFixed(1)}%</td>
                    `;
                });
            } else {
                topOverrunsTable.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">لا توجد بنود ذات زيادة حالياً</td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching project items:', error);
=======
<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <h3 class="mb-0">مقارنة التكاليف (تعاقدية وفعلية)</h3>
    </div>
    <div class="card-body">
        <canvas id="costComparisonChart"></canvas>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ctx = document.getElementById("costComparisonChart").getContext("2d");
        const chartData = {{ chart_data | tojson }};

        new Chart(ctx, {
            type: "bar",
            data: chartData,
            options: {
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "البند"
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "التكلفة (ريال)"
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: "مقارنة التكاليف التعاقدية والفعلية لكل بند"
                    }
                }
            }
>>>>>>> 7a3713e (Initial commit with updated files)
        });
    });
</script>
{% endblock %}
<<<<<<< HEAD
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
=======

>>>>>>> 7a3713e (Initial commit with updated files)
