{% extends "layouts/base.html" %}

{% block title %}تعديل الدفعة - {{ payment.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        تعديل الدفعة للمستخلص <a href="{{ url_for('invoice.show_invoice', invoice_id=payment.invoice_id) }}">{{ payment.invoice.invoice_number }}</a>
    </h1>
    <a href="{{ url_for('invoice.show_invoice', invoice_id=payment.invoice_id) }}" class="btn btn-secondary">
        <i class="fas fa-arrow-right me-1"></i> العودة للمستخلص
    </a>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0">بيانات الدفعة</h3>
    </div>
    <div class="card-body">
        <form id="paymentForm" method="POST" action="{{ url_for('invoice.edit_payment', payment_id=payment.id) }}">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="payment_date" class="form-label">تاريخ الدفعة</label>
                    <input type="date" class="form-control" id="payment_date" name="payment_date" value="{{ payment.payment_date.strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="col-md-6">
                    <label for="description" class="form-label">الوصف (اختياري)</label>
                    <input type="text" class="form-control" id="description" name="description" value="{{ payment.description or '' }}">
                </div>
            </div>
            
            <h6 class="mt-4">توزيع مبلغ الدفعة على البنود</h6>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>البند</th>
                            <th class="text-end">المتبقي + المدفوع حالياً</th>
                            <th style="width: 150px;">المبلغ المدفوع</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inv_item in invoice.items %}
                            {% set current_dist_amount = dists.get(inv_item.id, 0) %}
                            {% set max_allowed = inv_item.remaining_amount + current_dist_amount %}
                            
                            {% if max_allowed > 0 or current_dist_amount > 0 %}
                            <tr>
                                <td>{{ inv_item.description | truncate(70) }}</td>
                                <td class="text-end">{{ "{:,.2f}".format(max_allowed) }}</td>
                                <td>
                                    <input type="number" 
                                           class="form-control form-control-sm payment-dist-input"
                                           name="dist_item_{{ inv_item.id }}" 
                                           step="0.01" 
                                           min="0"
                                           max="{{ max_allowed }}"
                                           value="{{ current_dist_amount if current_dist_amount > 0 else '' }}"
                                           placeholder="0.00">
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mt-3 d-flex justify-content-between">
                 <div>
                    <strong>الإجمالي: </strong>
                    <span id="totalPaymentAmount" class="fw-bold text-success fs-5">0.00</span> ريال
                </div>
                <div>
                    <button type="submit" id="submitPaymentBtn" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> حفظ التعديلات
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        const distInputs = paymentForm.querySelectorAll('.payment-dist-input');
        const totalAmountDisplay = paymentForm.querySelector('#totalPaymentAmount');
        const submitBtn = paymentForm.querySelector('#submitPaymentBtn');

        function updateTotal() {
            let total = 0;
            distInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            totalAmountDisplay.textContent = total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            submitBtn.disabled = total <= 0;
        }

        distInputs.forEach(input => {
            input.addEventListener('input', () => {
                const value = parseFloat(input.value) || 0;
                const max = parseFloat(input.max);
                if (value > max) {
                    input.value = max;
                }
                if (value < 0) {
                    input.value = 0;
                }
                updateTotal();
            });
        });
        
        // Initial calculation on page load
        updateTotal();
    }
});
</script>
{% endblock %}

